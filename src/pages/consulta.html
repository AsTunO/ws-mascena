<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Sinistro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <link rel="stylesheet" href="./styles/consulta-style.css">
</head>

<body>

    <!-- Header -->
    <header class="bg-white text-dark py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="m-0">Consulta de Sinistro</h1>
            <nav>
                <a href="index.html" class="btn btn-outline-dark">Inicio</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Formulário de Consulta -->
        <div class="container mt">
            <h1 class="text-center"><i class="fas fa-search"></i> Pesquisa de Sinistro</h1>
            <form id="pesquisaForm" class="mb-3">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Número de referência</label>
                        <input type="text" class="form-control" id="numeroReferencia" style="text-transform:uppercase;">
                    </div>
                    <div class="col-md-4 d-flex">
                        <button type="button" class="btn btn-primary w-50" onclick="pesquisarSinistro()">
                            <i class="fas fa-search"></i> Pesquisar
                        </button>
                        <button type="button" class="btn btn-secondary w-50 ms-2" onclick="limparCampos()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </form>
            <!-- Dentro do resultado -->
            <div id="resultados" class="container mt-5 border border-2 p-4">
                <h3 class="text-center"><i class="fas fa-list"></i> Resultado da Busca</h3>
                <label class="form-label">Objeto</label>
                <input type="text" class="form-control" id="sinistroObjeto" style="text-transform:uppercase;" placeholder="">

                <div class="sinistro-details mt-3">
                    <div>
                        <label class="form-label">Tipo do Sinistro</label>
                        <input type="text" class="form-control" id="sinistroTipo" placeholder="">
                    </div>
                    <div>
                        <label class="form-label">Data da notificação</label>
                        <input type="text" class="form-control" id="sinistroData" placeholder="" style="color: red;">
                    </div>
                </div>

                <!-- Botões de devolver e voltar -->
                <div class="mt-3 d-flex justify-content-between">
                    <button type="button" class="btn btn-danger w-45" onclick="devolverCampos()">Devolver</button>
                    <a href="index.html" class="btn btn-outline-dark w-45">Voltar</a>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-secondary text-white text-center py-3 mt-5">
        <p>Contato: +55 (81) 7116-0236 | Email: arthur.mascena@hotmail.com </p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        async function pesquisarSinistro() {
            const numeroReferencia = document.getElementById('numeroReferencia').value;
            const resultadosDiv = document.getElementById('resultados');

            // Verificar se o campo de número de referência está vazio
            if (!numeroReferencia.trim()) {
                alert('Por favor, informe um número de referência válido.');
                return; // Impede a execução do restante da função
            }

            // Limpar resultados anteriores
            const sinistroObjeto = document.getElementById('sinistroObjeto');
            const sinistroTipo = document.getElementById('sinistroTipo');
            const sinistroData = document.getElementById('sinistroData');

            sinistroObjeto.value = '';
            sinistroTipo.value = '';
            sinistroData.value = '';

            // Remover o botão "Baixar Nada Consta", caso exista
            const oldButton = document.getElementById('downloadButton');
            if (oldButton) {
                oldButton.remove();
            }

            // Fazer a requisição à API
            const response = await fetch(`https://consulta.familiamascena.com.br/api/api/sheets`);
            const data = await response.json();

            if (data.success) {
                // Filtrar os sinistros com base no número de referência
                const sinistros = data.data.filter(sinistro => sinistro[0] === numeroReferencia);

                if (sinistros.length > 0) {
                    const sinistro = sinistros[0]; // Vamos usar apenas o primeiro sinistro

                    // Atualizar os placeholders
                    sinistroObjeto.placeholder = sinistro[1];
                    sinistroTipo.placeholder = sinistro[2];
                    sinistroData.placeholder = sinistro[3];
                } else {
                    sinistroObjeto.placeholder = 'Nenhum sinistro encontrado.';
                    sinistroTipo.placeholder = '';
                    sinistroData.placeholder = '';

                    // Criar botão para download
                    const downloadButton = document.createElement('button');
                    downloadButton.id = 'downloadButton';
                    downloadButton.classList.add('btn', 'btn-secondary', 'mt-3');
                    downloadButton.innerHTML = 'Baixar Nada Consta';
                    downloadButton.onclick = () => gerarDOCX(numeroReferencia);
                    resultadosDiv.appendChild(downloadButton);
                }

                // Exibir a seção de resultados
                resultadosDiv.style.display = 'block';
            } else {
                sinistroObjeto.placeholder = 'Erro ao carregar os dados.';
                sinistroTipo.placeholder = '';
                sinistroData.placeholder = '';
            }
        }

        async function gerarDOCX(numeroReferencia) {
            const response = await fetch("https://consulta.familiamascena.com.br/api/api/generate-docx", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ numeroReferencia })
            });

            if (response.ok) {
                // Criar link para download
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `Sinistro_${numeroReferencia}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert("Erro ao gerar o documento.");
            }
        }

        function limparCampos() {
            document.getElementById('numeroReferencia').value = '';
        }

        function devolverCampos() {
            document.getElementById('sinistroObjeto').value = '';
            document.getElementById('sinistroTipo').value = '';
            document.getElementById('sinistroData').value = '';

            document.getElementById('sinistroObjeto').placeholder = '';
        document.getElementById('sinistroTipo').placeholder = '';
        document.getElementById('sinistroData').placeholder = '';
        }
    </script>
</body>
</html>
