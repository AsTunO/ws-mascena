<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Sinistro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <link rel="stylesheet" href="./styles/consulta-style.css">
</head>

<body>

    <!-- Header -->
    <header class="bg-white text-dark py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="m-0">Consulta de Sinistro</h1>
            <nav>
                <a href="index.html" class="btn btn-outline-dark">Inicio</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Formulário de Consulta -->
        <div class="container mt">
            <h1 class="text-center"><i class="fas fa-search"></i> Pesquisa de Sinistro</h1>
            <form id="pesquisaForm" class="mb-3">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Número de referência</label>
                        <input type="text" class="form-control" id="numeroReferencia">
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-primary w-100" onclick="pesquisarSinistro()">
                            <i class="fas fa-search"></i> Pesquisar
                        </button>
                    </div>
                </div>
            </form>
            <div id="resultados" class="container mt-5 border border-2 p-4" style="display: none;">
                <h3 class="text-center"><i class="fas fa-list"></i> Resultado da Busca</h3>
                <ul id="listaSinistros" class="list-group mb-4"></ul>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-secondary text-white text-center py-3 mt-5">
        <p>Contato: +55 (81) 7116-0236 | Email: arthur.mascena@hotmail.com </p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
       async function pesquisarSinistro() {
    const numeroReferencia = document.getElementById('numeroReferencia').value;
    const listaSinistros = document.getElementById('listaSinistros');
    const resultadosDiv = document.getElementById('resultados');

    // Verificar se o campo de número de referência está vazio
    if (!numeroReferencia.trim()) {
        alert('Por favor, informe um número de referência válido.');
        return; // Impede a execução do restante da função
    }

    // Limpar lista de resultados
    listaSinistros.innerHTML = '';

    // Remover o botão "Baixar Nada Consta", caso exista
    const oldButton = document.getElementById('downloadButton');
    if (oldButton) {
        oldButton.remove();
    }

    // Fazer a requisição à API
    const response = await fetch(`http://127.0.0.1:3000/api/sheets`);
    const data = await response.json();

    if (data.success) {
        // Filtrar os sinistros com base no número de referência
        const sinistros = data.data.filter(sinistro => sinistro[0] === numeroReferencia);

        if (sinistros.length > 0) {
            sinistros.forEach(sinistro => {
                const item = document.createElement('li');
                item.classList.add('list-group-item');
                item.innerHTML = `<strong>${sinistro[1]}</strong> - ${sinistro[2]} - Sinistro #${sinistro[0]} - ${sinistro[4]} - ${sinistro[3]}`;
                listaSinistros.appendChild(item);
            });
        } else {
            listaSinistros.innerHTML = '<li class="list-group-item">Nenhum sinistro encontrado.</li>';

            // Criar botão para download
            const downloadButton = document.createElement('button');
            downloadButton.id = 'downloadButton';
            downloadButton.classList.add('btn', 'btn-secondary', 'mt-3');
            downloadButton.innerHTML = 'Baixar Nada Consta';
            downloadButton.onclick = () => gerarPDF(numeroReferencia);
            resultadosDiv.appendChild(downloadButton);
        }

        // Exibir a seção de resultados
        resultadosDiv.style.display = 'block';
    } else {
        listaSinistros.innerHTML = '<li class="list-group-item">Erro ao carregar os dados.</li>';
    }
}



        function gerarPDF(numeroReferencia) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Definir margens manualmente
            const margemEsquerda = 10;  // Margem à esquerda
            const margemDireita = 100;   // Margem à direita
            const larguraPagina = doc.internal.pageSize.width; // Largura da página
            const alturaPagina = doc.internal.pageSize.height; // Altura da página
            const margemHorizontal = larguraPagina - margemEsquerda - margemDireita; // Largura útil

            let linhaAtual = 20;  // A linha inicial onde começamos a escrever

            // Definir o título
            doc.setFontSize(16);
            doc.text('Relatório de Sinistro', margemEsquerda, linhaAtual);
            linhaAtual += 10;  // Ajustar para a próxima linha

            // Corpo do texto
            doc.setFontSize(12);
            doc.text(`Na presente data, nenhum sinistro foi identificado para o veículo.`, margemEsquerda, linhaAtual);
            linhaAtual += 10;  // Ajustar para a próxima linha
            doc.text(`Número de referência: ${numeroReferencia}`, margemEsquerda, linhaAtual);
            linhaAtual += 10;  // Ajustar para a próxima linha

            // Adicionar a data
            const dataAtual = new Date().toLocaleDateString();
            doc.text(`Data da consulta: ${dataAtual}`, margemEsquerda, linhaAtual);

            // Gerar o PDF com o nome do arquivo
            doc.save(`Sinistro_${numeroReferencia}.pdf`);
        }


    </script>

</body>

</html>